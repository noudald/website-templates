<!DOCTYPE HTML>
<html>
    <style>
        html, body {
            height: 95%;
        }

        #content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 90%;
        }

        #box {
        }
    </style>
    <body>
        <div id="content">
            <div id="box">
                <canvas id="canvas" width="220" height="220"></canvas>
            </div>
        </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Global configuration

        // Upper left and lower right points of box.
        const x0 = 20, y0 = 20, x1 = 200, y1 = 200;

        const boxWidth = x1 - x0;
        const boxHeight = y1 - y0;

        // Second box sizes
        const secondBoxHeight = 20;
        const secondBoxWidth = 6;

        // Breathing box
        const inhaleSeconds = 4;
        const holdInhaleSeconds = 4;
        const exhaleSeconds = 6;
        const holdExhaleSeconds = 2;
        const totalSeconds = inhaleSeconds + holdInhaleSeconds + exhaleSeconds + holdExhaleSeconds;

        const numberOfBoxCycles = 15;
        const displayRemaining = 2; // Show remaining cycles after each displayRemaining cycles.
        const helpBreaths = 3;

        function drawBox() {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y0);
            ctx.lineTo(x1, y1);
            ctx.lineTo(x0, y1);
            ctx.lineTo(x0, y0);
            ctx.stroke();
        }

        function drawSecondBox(px, py, orientation, time) {
            if (orientation == 'Horizontal') {
                ctx.fillRect(
                    px - secondBoxWidth/2,
                    py - time*secondBoxHeight/2,
                    secondBoxWidth,
                    time*secondBoxHeight
                );
            } else if (orientation == 'Vertical') {
                ctx.fillRect(
                    px - time*secondBoxHeight/2,
                    py - secondBoxWidth/2,
                    time*secondBoxHeight,
                    secondBoxWidth,
                );
            }
        }

        function drawBreath(startx, starty, orientation, numberOfBreaths, time) {
            var secondOrientation, xDistancePerSecondBox, yDistancePerSecondBox;

            if (orientation == 'Right') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Down') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = boxHeight / (numberOfBreaths + 1);
            } else if (orientation == 'Left') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = -boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Up') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = -boxHeight / (numberOfBreaths + 1);
            }

            [...Array(numberOfBreaths).keys()].map((i) => {
                if (i <= time - 1) {
                    drawSecondBox(
                        startx + (i + 1)*xDistancePerSecondBox,
                        starty + (i + 1)*yDistancePerSecondBox,
                        secondOrientation,
                        1.0
                    );
                } else if (0 <= time - i && time - i <= 1.0) {
                    drawSecondBox(
                        startx + (i + 1)*xDistancePerSecondBox,
                        starty + (i + 1)*yDistancePerSecondBox,
                        secondOrientation,
                        time - i
                    );
                }
            });
        }

        function hideBreath(startx, starty, orientation, numberOfBreaths, time) {
            var secondOrientation, xDistancePerSecondBox, yDistancePerSecondBox;

            if (orientation == 'Right') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Down') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = boxHeight / (numberOfBreaths + 1);
            } else if (orientation == 'Left') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = -boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Up') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = -boxHeight / (numberOfBreaths + 1);
            }

            [...Array(numberOfBreaths).keys()].map((i) => {
                drawSecondBox(
                    startx + (i + 1)*xDistancePerSecondBox,
                    starty + (i + 1)*yDistancePerSecondBox,
                    secondOrientation,
                    1.0 - time,
                );
            });
        }

        function writeTextFade(text, opacity) {
            ctx.font = '30px serif';
            ctx.textAlign = 'center';
            if (opacity < 1.0) {
                ctx.fillStyle = 'rgba(0, 0, 0, ' + opacity + ')';
            } else {
                ctx.fillStyle = 'rgba(0, 0, 0, 1)';
            }
            ctx.fillText(text, x0 + boxWidth/2, y0 + boxHeight/2 + 5);
            ctx.fillStyle = 'rgba(0, 0, 0, 1)';
        };

        function writeText(text) {
            writeTextFade(text, 1.0);
        };

        requestAnimationFrame(renderLoop);

        function finalLoop(time) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            drawBox();
            writeText('Done');

            const seconds = time/1000 % totalSeconds;
            if (0 <= seconds & seconds <= inhaleSeconds) {
                hideBreath(
                    x0,
                    y1,
                    'Up',
                    holdExhaleSeconds,
                    seconds/inhaleSeconds
                );
            } else {
                return;
            }

            requestAnimationFrame(finalLoop);
        }

        function renderLoop(time) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            drawBox();

            const seconds = time/1000 % totalSeconds;
            const numberOfBreaths = Math.floor(time/1000/totalSeconds);
            const remaining = numberOfBoxCycles - numberOfBreaths;

            if (remaining == 0) {
                requestAnimationFrame(finalLoop);
                return;
            }

            if (0 <= seconds & seconds <= inhaleSeconds) {
                if (numberOfBreaths < helpBreaths) {
                    writeText('Inhale', seconds);
                } else if (remaining == 1) {
                    if (seconds < inhaleSeconds - 1) {
                        writeTextFade('Last one', seconds);
                    } else {
                        writeTextFade('Last one', inhaleSeconds - seconds);
                    }
                } else if (remaining % displayRemaining == 0) {
                    if (seconds < inhaleSeconds - 1) {
                        writeTextFade(remaining + ' left', seconds);
                    } else {
                        writeTextFade(remaining + ' left', inhaleSeconds - seconds);
                    }
                }

                if (numberOfBreaths > 0) {
                    hideBreath(
                        x0,
                        y1,
                        'Up',
                        holdExhaleSeconds,
                        seconds/inhaleSeconds
                    );
                }
                drawBreath(
                    x0,
                    y0,
                    'Right',
                    inhaleSeconds,
                    seconds
                );
            } else if (inhaleSeconds <= seconds && seconds <= inhaleSeconds + holdInhaleSeconds) {
                if (numberOfBreaths < helpBreaths) {
                    writeText('Hold');
                }

                hideBreath(
                    x0,
                    y0,
                    'Right',
                    inhaleSeconds,
                    (seconds - inhaleSeconds)/holdInhaleSeconds
                );
                drawBreath(
                    x1,
                    y0,
                    'Down',
                    holdInhaleSeconds,
                    seconds - inhaleSeconds
                );
            } else if (inhaleSeconds + holdInhaleSeconds <= seconds
                    && seconds <= inhaleSeconds + holdInhaleSeconds + exhaleSeconds) {
                if (numberOfBreaths < helpBreaths) {
                    writeText('Exhale');
                }
                hideBreath(
                    x1,
                    y0,
                    'Down',
                    holdInhaleSeconds,
                    (seconds - inhaleSeconds - holdInhaleSeconds)/exhaleSeconds
                );
                drawBreath(
                    x1,
                    y1,
                    'Left',
                    exhaleSeconds,
                    seconds - inhaleSeconds - holdInhaleSeconds
                );
            } else {
                if (numberOfBreaths < helpBreaths) {
                    if (numberOfBreaths + 1 == helpBreaths && seconds > totalSeconds - 1) {
                        writeTextFade('Hold', totalSeconds - seconds);
                    } else {
                        writeText('Hold');
                    }
                }
                hideBreath(
                    x1,
                    y1,
                    'Left',
                    exhaleSeconds,
                    (seconds - inhaleSeconds - holdInhaleSeconds - exhaleSeconds)/holdExhaleSeconds
                );
                drawBreath(
                    x0,
                    y1,
                    'Up',
                    holdExhaleSeconds,
                    seconds - inhaleSeconds - holdInhaleSeconds - exhaleSeconds
                );
            }

            requestAnimationFrame(renderLoop);
        }
        </script>
    </body>
</html>
