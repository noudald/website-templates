<!DOCTYPE HTML>
<html>
    <style>
        #content {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    <body>
        <div id="content">
            <canvas id="canvas" width="220" height="220"></canvas>
        </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Global configuration

        // Upper left and lower right points of box.
        const x0 = 20, y0 = 20, x1 = 200, y1 = 200;

        const boxWidth = x1 - x0;
        const boxHeight = y1 - y0;

        // Second box sizes
        const secondBoxHeight = 20;
        const secondBoxWidth = 6;

        // Breathing box
        const inhaleBreaths = 4;
        const holdInhaleBreaths = 4;
        const exhaleBreaths = 6;
        const holdExhaleBreaths = 2;
        const totalBreaths = inhaleBreaths + holdInhaleBreaths + exhaleBreaths + holdExhaleBreaths;

        const helpBreaths = 3;

        function drawBox() {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y0);
            ctx.lineTo(x1, y1);
            ctx.lineTo(x0, y1);
            ctx.lineTo(x0, y0);
            ctx.stroke();
        }

        function drawSecondBox(px, py, orientation, time) {
            if (orientation == 'Horizontal') {
                ctx.fillRect(
                    px - secondBoxWidth/2,
                    py - time*secondBoxHeight/2,
                    secondBoxWidth,
                    time*secondBoxHeight
                );
            } else if (orientation == 'Vertical') {
                ctx.fillRect(
                    px - time*secondBoxHeight/2,
                    py - secondBoxWidth/2,
                    time*secondBoxHeight,
                    secondBoxWidth,
                );
            }
        }

        function drawBreath(startx, starty, orientation, numberOfBreaths, time) {
            var secondOrientation, xDistancePerSecondBox, yDistancePerSecondBox;

            if (orientation == 'Right') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Down') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = boxHeight / (numberOfBreaths + 1);
            } else if (orientation == 'Left') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = -boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Up') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = -boxHeight / (numberOfBreaths + 1);
            }

            [...Array(numberOfBreaths).keys()].map((i) => {
                if (i <= time - 1) {
                    drawSecondBox(
                        startx + (i + 1)*xDistancePerSecondBox,
                        starty + (i + 1)*yDistancePerSecondBox,
                        secondOrientation,
                        1.0
                    );
                } else if (0 <= time - i && time - i <= 1.0) {
                    drawSecondBox(
                        startx + (i + 1)*xDistancePerSecondBox,
                        starty + (i + 1)*yDistancePerSecondBox,
                        secondOrientation,
                        time - i
                    );
                }
            });
        }

        function hideBreath(startx, starty, orientation, numberOfBreaths, time) {
            var secondOrientation, xDistancePerSecondBox, yDistancePerSecondBox;

            if (orientation == 'Right') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Down') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = boxHeight / (numberOfBreaths + 1);
            } else if (orientation == 'Left') {
                secondOrientation = 'Horizontal';
                xDistancePerSecondBox = -boxWidth / (numberOfBreaths + 1);
                yDistancePerSecondBox = 0;
            } else if (orientation == 'Up') {
                secondOrientation = 'Vertical';
                xDistancePerSecondBox = 0;
                yDistancePerSecondBox = -boxHeight / (numberOfBreaths + 1);
            }

            [...Array(numberOfBreaths).keys()].map((i) => {
                drawSecondBox(
                    startx + (i + 1)*xDistancePerSecondBox,
                    starty + (i + 1)*yDistancePerSecondBox,
                    secondOrientation,
                    1.0 - time,
                );
            });
        }

        function writeText(text) {
            ctx.font = '30px serif';
            ctx.textAlign = 'center';
            ctx.strokeText(text, x0 + boxWidth/2, y0 + boxHeight/2);
        };

        requestAnimationFrame(renderLoop);  // rAF to start animation

        function renderLoop(time) {  // rAF callback
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            drawBox();

            const seconds = time/1000 % totalBreaths;
            const numberOfBreaths = Math.floor(time/1000/totalBreaths);

            if (0 <= seconds & seconds <= inhaleBreaths) {
                if (numberOfBreaths < helpBreaths) {
                    writeText('Inhale');
                }

                if (numberOfBreaths > 0) {
                    hideBreath(
                        x0,
                        y1,
                        'Up',
                        holdExhaleBreaths,
                        seconds/inhaleBreaths
                    );
                }
                drawBreath(
                    x0,
                    y0,
                    'Right',
                    inhaleBreaths,
                    seconds
                );
            } else if (inhaleBreaths <= seconds && seconds <= inhaleBreaths + holdInhaleBreaths) {
                if (numberOfBreaths < helpBreaths) {
                    writeText('Hold');
                }

                hideBreath(
                    x0,
                    y0,
                    'Right',
                    inhaleBreaths,
                    (seconds - inhaleBreaths)/holdInhaleBreaths
                );
                drawBreath(
                    x1,
                    y0,
                    'Down',
                    holdInhaleBreaths,
                    seconds - inhaleBreaths
                );
            } else if (inhaleBreaths + holdInhaleBreaths <= seconds
                    && seconds <= inhaleBreaths + holdInhaleBreaths + exhaleBreaths) {
                if (numberOfBreaths < helpBreaths) {
                    writeText('Exhale');
                }
                hideBreath(
                    x1,
                    y0,
                    'Down',
                    holdInhaleBreaths,
                    (seconds - inhaleBreaths - holdInhaleBreaths)/exhaleBreaths
                );
                drawBreath(
                    x1,
                    y1,
                    'Left',
                    exhaleBreaths,
                    seconds - inhaleBreaths - holdInhaleBreaths
                );
            } else {
                if (numberOfBreaths < helpBreaths) {
                    writeText('Hold');
                }
                hideBreath(
                    x1,
                    y1,
                    'Left',
                    exhaleBreaths,
                    (seconds - inhaleBreaths - holdInhaleBreaths - exhaleBreaths)/holdExhaleBreaths
                );
                drawBreath(
                    x0,
                    y1,
                    'Up',
                    holdExhaleBreaths,
                    seconds - inhaleBreaths - holdInhaleBreaths - exhaleBreaths
                );
            }

            requestAnimationFrame(renderLoop);  // request next frame
        }
        </script>
    </body>
</html>
